@page "/pumpstatus"
@using BachelorApp.Interfaces;
@using BachelorApp.Services;
@using System.Diagnostics;
@inject IBachelorPageModel model
@inject IReadingService service;

<h3>Pump Status</h3>
<br>

<div id="displayStatus">
    <p>
        @response
    </p>
</div>
<div id="entryFields">
    <div id="entryFields2" class="col w-50">
        <div class="col d-flex">
            <label>P1 Start Quantity</label>
            <input @bind="p1Start" />
        </div>
        <div class="col d-flex">
            <label>P1 Operating Time</label>
            <input @bind="p1OperTime" />
        </div>
        <div class="col d-flex">
            <label>P2 Start Quantity</label>
            <input @bind="p2Start" />
        </div>
        <div class="col d-flex">
            <label>P2 Operating Time</label>
            <input @bind="p2OperTime" />
        </div>
        <div class="col d-flex">
            <label>Rain(mm)</label>
            <input @bind="rain" />
        </div>
        <div class="col d-flex">
            <label>Niveau(cm)</label>
            <input @bind="niveau" />
        </div>
        <div class="col d-flex">
            <label>Month</label>
            <input @bind="month" />
        </div>
        <div class="col d-flex">
            <label>Day</label>
            <input @bind="day" />
        </div>
        <div class="col d-flex">
            <label>Hour</label>
            <input @bind="hour" />
        </div>

    </div>

</div>
<br>
<button type="button" class="btn btn-primary" @onclick="Request">Update List</button>

@code {
    //Object to send to the python module, same object will be saved with updated values to the database
    private Reading reading;
    private float p1Start = 1, p1OperTime = 3, p2Start = 2, p2OperTime = 4, niveau = 6, rain = 5;
    private int month = 7, day = 8, hour = 9;

    //Response received from the python module (json string)
    private String response;
    //Prediction label (Abnormal,Normal)
    private String label;
    //Probability of given label being true (float)
    private float probability;

    //A timer to time the duration of a request
    private Stopwatch stopWatch = new Stopwatch();

    async Task Request()
    {
        //On request assing the input values to the object
        reading = new Reading();
        reading.P1StartQuantity = p1Start;
        reading.P1OperatingTime = p1OperTime;
        reading.P2StartQuantity = p2Start;
        reading.P2OperatingTime = p2OperTime;
        reading.Rain = rain;
        reading.Niveau = niveau;
        reading.month = month;
        reading.day = day;
        reading.hour = hour;

        stopWatch.Start();
        //Response gets updated automatically on the page, when the request is finished
        response = await model.PutReadingItemAsync(reading);
        stopWatch.Stop();

        //Spliting label and probability after receiving the response
        SplitLabelAndProbability();
        await service.AddReading(reading);

        //Display time it took for the request to finish
        response = "Time of request in seconds: " + stopWatch.Elapsed.TotalSeconds;
    }

    //Splitting the response string into a string label and float probability :.4f
    void SplitLabelAndProbability()
    {
        int position = response.IndexOf("[\"");
        int position1 = response.IndexOf(",");
        int position2 = response.IndexOf(" ");
        var label = response.Substring(position + 2, position1 - position - 2);
        var proba = response.Substring(position1 - position + 2, 6);
        var proba2 = response.Substring(position2 + 1, 6);

        float value = float.Parse(proba);
        float value1 = float.Parse(proba2);
        float probability = 0;
        if (value < value1)
            probability = value1;
        else
            probability = value;
        //Add prediction to the reading object before saving into database
        reading.label = label;
        reading.probability = probability;
    }
}
